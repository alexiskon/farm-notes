name: Publish Expo preview

on:
  push:
    branches: [main]

jobs:
  preview:
    runs-on: ubuntu-latest

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_PROJECT_ID: 6811dcaf-2195-4a0e-ba6b-b561e60da885 # Replace with your actual project ID

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install jq
        run: sudo apt-get install jq

      - name: Publish update to 'main' channel
        run: |
          eas update --auto \
            --branch main \
            --non-interactive \
            --message "CI update $GITHUB_SHA"

      - name: Get latest update QR code
        id: get_qr
        run: |
          UPDATE_JSON=$(eas update:view --branch main --latest --json)
          QR_URL=$(echo "$UPDATE_JSON" | jq -r '.qrCodeUrl')
          echo "QR_URL=$QR_URL" >> "$GITHUB_OUTPUT"

      - name: Update README.md with QR code
        run: |
          QR_URL="${{ steps.get_qr.outputs.QR_URL }}"
          FILE=README.md

          if grep -q '<!-- EXPO_QR_START -->' "$FILE"; then
            # Replace block between markers
            sed -i "/<!-- EXPO_QR_START -->/,/<!-- EXPO_QR_END -->/c\\
            <!-- EXPO_QR_START -->\\
            ## Live preview\\
            \\
            ![Scan in Expo Go](${QR_URL})\\
            <!-- EXPO_QR_END -->
            " "$FILE"
          else
            # Append the section if markers are not present
            echo -e "\n<!-- EXPO_QR_START -->\n## Live preview\n\n![Scan in Expo Go](${QR_URL})\n<!-- EXPO_QR_END -->" >> "$FILE"
          fi

      - name: Configure Git for commit
        run: |
          git config user.name "Alexandros Kontos"
          git config user.email "alexiskon@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/alexiskon/farm-notes.git

      - name: Commit changes if needed
        run: |
          git diff --quiet || {
            git add README.md
            git commit -m "Update QR code for latest Expo preview"
            git push
          }
